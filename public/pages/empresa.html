<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../assets/styles/style.css">
    <link href="https://cdn.datatables.net/v/dt/dt-2.1.8/datatables.min.css" rel="stylesheet">
    <script src="../assets/JS/jquery-3.7.1.min.js"></script>
    <script src="../assets/JS/carhartl-jquery-cookie-92b7715/jquery.cookie.js"></script>
    <script src="https://cdn.datatables.net/v/dt/dt-2.1.8/datatables.min.js"></script>
    <title>Green Place</title>
</head>
<body>

    <header class="header_empresa">
        <h1 class="nome_empresa"></h1>
    </header>
    <main class="main_empresa">
        <table class="produtos_table">
            <thead>
                <tr>
                    <th>Categoria</th>
                    <th>Produto</th>
                    <th>Preço</th>
                    <th>Quantidade</th>
                    <th>Carrinho</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <div id="modalCarrinho" class="modal" >
            <div class="modal-content">
                <header class="header_modal">
                    <h2 id="produto_nome"></h2>
                </header>
                <form method="post">
                    <p>Preço Unitário: <span id="preco_unitario"></span></p>
                    
                    <label for="quantidade">Quantidade:</label>
                    <input type="number" id="quantidade" name="quantidade" min="1" value="1">
                    
                    <p>Total: <span id="preco_total"></span></p>
            
                    <button type="button" id="confirmar_adicao">Adicionar ao Carrinho</button>
                </form>
            </div>
        </div>
    </main>

    <script>
        const user_id = $.cookie("user_id");
        if(!user_id) {
            window.location.href = "/pages/login.html";
        }

        const urlParams = new URLSearchParams(window.location.search);
        const empresa_id = urlParams.get("id");
        const data = JSON.stringify({ id: empresa_id });
        let tabela;

        $.ajax({
            url: "http://localhost:8080/empresa",
            method: "POST",
            data: data,
            contentType: "application/json", 
            success: function(response) {
                $(".nome_empresa").text(response.empresa.nome);

                tabela = $(".produtos_table").DataTable({
                    data: response.produtos,
                    destroy: true, 
                    responsive: true,
                    columns: [
                        { 
                            data: "id_categoria",
                            render: function(data) {
                                const categorias = [
                                    "Grãos e Cereais",
                                    "Produtos Orgânicos",
                                    "Sementes",
                                    "Fertilizantes",
                                    "Outros"
                                ];
                                return categorias[data - 1]; 
                            }
                        },
                        { data: "produto" },
                        { data: "preco_unitario", render: function(data) { return `R$ ${Number(data).toFixed(2)}`; } },
                        { data: "qntd_estoque" },
                        { 
                            data: null, 
                            render: function(data) {
                                return `<button class="adicionar-carrinho">Adicionar ao Carrinho</button>`;
                            }
                        }
                    ]
                });
            }
        });

        function abrirModal(produto) {
            $("#produto_nome").text(produto.produto);
            $("#preco_unitario").text(`R$ ${Number(produto.preco_unitario).toFixed(2)}`);
            $("#preco_total").text(`R$ ${Number(produto.preco_unitario).toFixed(2)}`);
            $("#quantidade").val(1);
            $("#modalCarrinho").show();

            $("#quantidade").on("input", function() {
                let quantidade = $(this).val();
                let precoTotal = produto.preco_unitario * quantidade;
                $("#preco_total").text(`R$ ${precoTotal.toFixed(2)}`);
            });

            $("#confirmar_adicao").off("click").on("click", function() {
                const quantidade = $("#quantidade").val();
                const valorTotal = produto.preco_unitario * quantidade;
                const carrinhoData = {
                    "id_cliente" :user_id,
                    "id_empresa_pertencente": empresa_id,
                    "id_produto": produto.id,
                    quantidade,
                    valor_total: valorTotal
                };
                
                $.ajax({
                    url: "http://localhost:8080/addCarrinhoProduto",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(carrinhoData),
                    success: function() {
                        alert("Produto adicionado ao carrinho com sucesso!");
                        $("#modalCarrinho").hide();
                    },
                    error: function(error) {
                        alert("Erro ao adicionar produto ao carrinho.");
                    }
                });
            });
        }

        $(".produtos_table").on("click", ".adicionar-carrinho", function() {
            const rowData = tabela.row($(this).closest("tr")).data();
            abrirModal(rowData);
        });

        $(window).on("click", function(event) {
            if ($(event.target).is("#modalCarrinho")) {
                $("#modalCarrinho").hide();
            }
        });
    </script>
</body>
</html>
