<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../assets/styles/style.css">
    <link href="https://cdn.datatables.net/v/dt/dt-2.1.8/datatables.min.css" rel="stylesheet">
    <script src="../assets/JS/jquery-3.7.1.min.js"></script>
    <script src="../assets/JS/carhartl-jquery-cookie-92b7715/jquery.cookie.js"></script>
    <script src="https://cdn.datatables.net/v/dt/dt-2.1.8/datatables.min.js"></script>
    <title>Green Place</title>
</head>
<body>
    <header class="index_header">
        <h1>Green Place</h1>
        <section class="action">
            <a href="/pages/minhaEmpresa.html">
                <img width="50" height="50" src="https://img.icons8.com/ios-filled/50/client-company.png" alt="client-company" />
            </a>
            <a href="/pages/carrinho.html">
                <img width="50" height="50" src="https://img.icons8.com/pulsar-color/50/shopping.png" alt="shopping" />
            </a>
        </section>
    </header>
    <main class="main_minhaEmpresa">
        <button style="margin-left: 4%;" class="addProduto">Adicionar Produto</button>
        <button class="produtosVendidos">Produtos Vendidos</button>
        <button class="gerarPdfProdutos">Gerar PDF - Produtos da Empresa</button>
        <table class="produtos_table" id="produtosTable">
            <thead>
                <tr>
                    <th>Categoria</th>
                    <th>Produto</th>
                    <th>Preço</th>
                    <th>Quantidade</th>
                    <th>Editar</th>
                    <th>Remover</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </main>
    <div id="modalAdicaoProduto" class="modal" style="display: none;">
        <div class="modal-content">
            <header class="header_modal">
                <h2>Adição de Produto</h2>
            </header>
            <form id="formProduto">
                <label for="nome_produto">Nome do Produto:</label>
                <input placeholder="Digite o nome do produto" name="nome_produto" id="nome_produto" type="text" required />
                <label for="quantidade">Quantidade:</label>
                <input placeholder="Digite a quantidade" type="number" id="quantidade" name="quantidade" min="1" value="1" required />
                <label for="preco">Preço Unitário:</label>
                <input placeholder="Digite o preço do produto" type="number" id="preco" name="preco" step="0.01" required />
                <label for="categoria">Categoria:</label>
                <select id="categoria" name="categoria" required>
                    <option value="1">Grãos e Cereais</option>
                    <option value="2">Produtos Orgânicos</option>
                    <option value="3">Sementes</option>
                    <option value="4">Fertilizantes</option>
                    <option value="5">Outros</option>
                </select>
                <button type="button" id="confirmar_adicao">Confirmar</button>
            </form>
        </div>
    </div>
    <div id="modalProdutosVendidos" class="modal" style="display: none;">
        <div class="modal-content">
            <header class="header_modal">
                <h2>Produtos Vendidos</h2>
            </header>
            <table class="produtos_vendidos_table" id="produtosVendidosTable">
                <thead>
                    <tr>
                        <th>Categoria</th>
                        <th>Produto</th>
                        <th>Cliente</th>
                        <th>Valor Total</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <script>
        let tabela;
        $.ajax({
            url: "http://localhost:8080/meusProdutos",
            method: "POST",
            data: JSON.stringify({ user_id: $.cookie("user_id") }),
            contentType: "application/json",
            success: function (response) {
                tabela = $(".produtos_table").DataTable({
                    data: response,
                    destroy: true,
                    responsive: true,
                    columns: [
                        {
                            data: "id_categoria",
                            render: function (data) {
                                const categorias = [
                                    "Grãos e Cereais",
                                    "Produtos Orgânicos",
                                    "Sementes",
                                    "Fertilizantes",
                                    "Outros",
                                ];
                                return categorias[data - 1]
                            },
                        },
                        { data: "produto" },
                        {
                            data: "preco_unitario",
                            render: function (data) {
                                return `R$ ${parseFloat(data).toFixed(2)}`;
                            },
                        },
                        { data: "qntd_estoque" },
                        {
                            data: null,
                            render: function () {
                                return '<button class="editar-produto">Editar</button>';
                            },
                        },
                        {
                            data: null,
                            render: function () {
                                return '<button class="remover-produto">Remover</button>';
                            },
                        },
                    ],
                });
            },
        });

        function abrirModal(selector) {
            $(selector).show();
        }

        $(".addProduto").on("click", function () {
            abrirModal("#modalAdicaoProduto");
        });

        $(".produtosVendidos").on("click", function () {
            $.ajax({
                url: `http://localhost:8080/produtosVendidos/${$.cookie("user_id")}`,
                method: "GET",
                success: function (response) {
                    $("#produtosVendidosTable").DataTable({
                        data: response,
                        destroy: true,
                        responsive: true,
                        columns: [
                            {
                                data: "categoria",
                                render: function(data){
                                    const categorias = [
                                        "Grãos e Cereais",
                                        "Produtos Orgânicos",
                                        "Sementes",
                                        "Fertilizantes",
                                        "Outros",
                                    ];
                                    return categorias[data - 1]
                                }
                            },
                            { data: "produto" },
                            { data: "cliente" },
                            {
                                data: "valor_total",
                                render: function (data) {
                                    return `R$ ${parseFloat(data).toFixed(2)}`;
                                },
                            },
                        ],
                    });
                    abrirModal("#modalProdutosVendidos");
                },
            });
        });

        $(window).on("click", function (event) {
            if ($(event.target).is("#modalAdicaoProduto") || $(event.target).is("#modalProdutosVendidos")) {
                $(".modal").hide();
            }
        });

        $("#confirmar_adicao").on("click", function () {
            const produto = {
                produto: $("#nome_produto").val(),
                qntd_estoque: $("#quantidade").val(),
                preco_unitario: $("#preco").val(),
                id_categoria: $("#categoria option:selected").val(),
                user_id: $.cookie("user_id"),
            };

            $.ajax({
                url: "http://localhost:8080/registerProduto",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(produto),
                success: function () {
                    window.location.reload();
                },
            });
        });

        $("#produtosTable").on("click", ".remover-produto", function () {
            const row = tabela.row($(this).closest("tr"));
            const data = row.data();

            if (confirm(`Deseja remover o produto "${data.produto}"?`)) {
                $.ajax({
                    url: `http://localhost:8080/removeProduto/${data.id}`,
                    method: "DELETE",
                    success: function () {
                        row.remove().draw();
                    },
                });
            }
        });

        $("#produtosTable").on("click", ".editar-produto", function () {
            const row = tabela.row($(this).closest("tr"));
            const data = row.data();

            $("#nome_produto").val(data.produto);
            $("#quantidade").val(data.qntd_estoque);
            $("#preco").val(data.preco_unitario);
            $("#categoria").val(data.id_categoria);

            abrirModal("#modalAdicaoProduto");

            $("#confirmar_adicao").off("click").on("click", function () {
                const atualizado = {
                    produto: $("#nome_produto").val(),
                    qntd_estoque: $("#quantidade").val(),
                    preco_unitario: $("#preco").val(),
                    id_categoria: $("#categoria").val(),
                };

                $.ajax({
                    url: `http://localhost:8080/updateProduto/${data.id}`,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify(atualizado),
                    success: function () {
                        window.location.reload();
                    },
                });
            });
        });

        //Parte resonsável por enviar a tabela do front end p/ o back end
        //E fazer a instalação pdf da mesma.
        $(".gerarPdfProdutos").on("click", function () {
            const tabelaProdutos = tabela.rows().data().toArray();
            $.ajax({
                url: "http://localhost:8080/gerarPdf",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(tabelaProdutos),
                xhrFields: {
                    responseType: "blob", 
                },
                success: function (response) {
                    const url = window.URL.createObjectURL(new Blob([response], { type: "application/pdf" }));
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = "produtos_empresa.pdf";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },
                error: function (err) {
                    alert("Erro ao gerar o PDF. Tente novamente.");
                },
            });
        });
    </script>
</body>
</html>